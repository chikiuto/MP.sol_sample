<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8">
	<title>Marketplace front-end</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<!-- <script language="javascript" type="text/javascript" src="web3.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
	<script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

	<!-- <script src="kkk.js"></script> -->
	<!-- <script src="ppp.js"></script> -->
	<script src="ggg.js"></script>
	
  </head>
  <body>
	<div id="txStatus">

	</div>
	<script>
	  var cryptoZombies;
	  var userAccount;

	//   async function createToken(web3, contract) {
	// 	//massage the params to be sent to the create NFT request
	// 	// const price = web3.eth.utils.parseUnits(formParams.price, 'ether')
    //     // let listingPrice = await contract.getListPrice()
    //     // listingPrice = listingPrice.toString()
	// 	// console.log(listingPrice);

	// 	let transaction = await contract.createtoken("https://filedown12.cais.niigata-u.ac.jp/d/g1QGaIX91oVr1MjNP2q3yyOK", 2);
    //     await transaction.wait()
	// 	console.log(transaction)
	//   }

	  function startApp() {

		//step1. set address and abi
		// https://goerli.etherscan.io/address/0x2f8F7D0AaCeB1c5fF873864e3A0478403Ed566b2
		var ContractAddress = "0x2f8F7D0AaCeB1c5fF873864e3A0478403Ed566b2";
		const abi = MP_ABI;

		//step2. Createing signer
		// https://eth-goerli.g.alchemy.com/v2/O2_6ZL9WCZTXWkBQNVvIOJKdsf-OgFcv
		// https://docs.ethers.io/v5/migration/web3/
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    console.log(provider);

		//step3. Connecting to Ethereum: MetaMask
		// https://docs.ethers.io/v5/getting-started/#getting-started--connecting
		const account = async() => {
			await provider.send("eth_requestAccounts", []);
		};
		account();
		const signer = provider.getSigner()
		console.log(signer);


		//step4. Interacting with a contract
		const contract = new ethers.Contract(ContractAddress, abi, signer);
        console.log(contract);

		const result = async() => {
			// let listPrice = await contract.updateListPrice( ethers.utils.parseEther( "0.001" ) );
			// listPrice = await contract.getListPrice();
			// await console.log(listPrice)
			// await console.log(listPrice.toString())
			//formatEtherはStringで返す
			// await console.log( ethers.utils.formatEther( listPrice ) );

			let AllNFTs = await contract.getAllNFTs();
			console.log(AllNFTs)

			let myNFTs = await contract.getMyNFTs();
			console.log(myNFTs)

			// let Sale = await contract.executeSale( 6, {value: ethers.utils.parseEther( "0.001" )} );
        };
		result();

		

		// contract.methods.createToken("https://filedown12.cais.niigata-u.ac.jp/d/g1QGaIX91oVr1MjNP2q3yyOK", 2).call();
		// createToken(web3.contract);
		
		// サンプル画像ファイル保存先
		// https://filedown12.cais.niigata-u.ac.jp/d/g1QGaIX91oVr1MjNP2q3yyOK

        // var accountInterval = setInterval(function() {
		//   // Check if account has changed
		//   if (web3.eth.accounts[0] !== userAccount) {
		// 	userAccount = web3.eth.accounts[0];
		// 	// Call a function to update the UI with the new account
		// 	getZombiesByOwner(userAccount)
		// 	.then(displayZombies);
		//   }
		// }, 100);

		// ここから始めよ
		// `_to`が`userAccount`と等しいときだけこのコードが動作するように`filter`を使う
		// cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
		// .on("data", function(event) {
		//   let data = event.returnValues;
		//   // 現在のユーザーがゾンビを受け取った！
		//   // それを示すようUIをアップデートする何かを行おう
		//   getZombiesByOwner(userAccount).then(displayZombies);
		// }).on("error", console.error);
	  }

	//   function displayZombies(ids) {
	// 	$("#zombies").empty();
	// 	for (id of ids) {
	// 	  // Look up zombie details from our contract. Returns a `zombie` object
	// 	  getZombieDetails(id)
	// 	  .then(function(zombie) {
	// 		// Using ES6's "template literals" to inject variables into the HTML.
	// 		// Append each one to our #zombies div
	// 		$("#zombies").append(`<div class="zombie">
	// 		  <ul>
	// 			<li>Name: ${zombie.name}</li>
	// 			<li>DNA: ${zombie.dna}</li>
	// 			<li>Level: ${zombie.level}</li>
	// 			<li>Wins: ${zombie.winCount}</li>
	// 			<li>Losses: ${zombie.lossCount}</li>
	// 			<li>Ready Time: ${zombie.readyTime}</li>
	// 		  </ul>
	// 		</div>`);
	// 	  });
	// 	}
	//   }

	//   function createRandomZombie(name) {
	// 	// This is going to take a while, so update the UI to let the user know
	// 	// the transaction has been sent
	// 	$("#txStatus").text("Creating new zombie on the blockchain. This may take a while...");
	// 	// Send the tx to our contract:
	// 	return cryptoZombies.methods.createRandomZombie(name)
	// 	.send({ from: userAccount })
	// 	.on("receipt", function(receipt) {
	// 	  $("#txStatus").text("Successfully created " + name + "!");
	// 	  // Transaction was accepted into the blockchain, let's redraw the UI
	// 	  getZombiesByOwner(userAccount).then(displayZombies);
	// 	})
	// 	.on("error", function(error) {
	// 	  // Do something to alert the user their transaction has failed
	// 	  $("#txStatus").text(error);
	// 	});
	//   }

	//   function feedOnKitty(zombieId, kittyId) {
	// 	$("#txStatus").text("Eating a kitty. This may take a while...");
	// 	return cryptoZombies.methods.feedOnKitty(zombieId, kittyId)
	// 	.send({ from: userAccount })
	// 	.on("receipt", function(receipt) {
	// 	  $("#txStatus").text("Ate a kitty and spawned a new Zombie!");
	// 	  getZombiesByOwner(userAccount).then(displayZombies);
	// 	})
	// 	.on("error", function(error) {
	// 	  $("#txStatus").text(error);
	// 	});
	//   }

	//   function levelUp(zombieId) {
	// 	$("#txStatus").text("Leveling up your zombie...");
	// 	return cryptoZombies.methods.levelUp(zombieId)
	// 	.send({ from: userAccount, value: web3.utils.toWei("0.001", "ether") })
	// 	.on("receipt", function(receipt) {
	// 	  $("#txStatus").text("Power overwhelming! Zombie successfully leveled up");
	// 	})
	// 	.on("error", function(error) {
	// 	  $("#txStatus").text(error);
	// 	});
	//   }

	//   function getZombieDetails(id) {
	// 	return cryptoZombies.methods.zombies(id).call();
	//   }

	//   function zombieToOwner(id) {
	// 	return cryptoZombies.methods.zombieToOwner(id).call();
	//   }

	//   function getZombiesByOwner(owner) {
	// 	return cryptoZombies.methods.getZombiesByOwner(owner).call();
	//   }

	  window.addEventListener('load', function() {

		// Checking if Web3 has been injected by the browser (Mist/MetaMask)
		// if (typeof web3 !== 'undefined') {
		//   // Use Mist/MetaMask's provider
		//   web3js = new Web3(web3.currentProvider);
		// } else {
		//   // Handle the case where the user doesn't have Metamask installed
		//   // Probably show them a message prompting them to install Metamask
		// }
		

		// Now you can start your app & access web3 freely:
		startApp()

	  })
	</script>
  </body>
</html>